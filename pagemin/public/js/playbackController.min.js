;
var playbackController=function(){
};

playbackController.doubleClickedElement=function(event){
event.stopPropagation();
}
playbackController.touchedElement=function(event,onlyStyle){
if($(event.target).is("li"))
var listElement=$(event.target);
else
listElement=$(event.target).parents("li");
var element=listElement.data("song");
playbackController.clickedElement(event,element,onlyStyle);
}

playbackController.clickedElement=function(event,element,onlyStyle){
if(uiController.swipeTimer&&Date.now()-uiController.swipeTimer<100)
return;
var songlist=$(event.target).parents("li")
if(songlist.length>0&&(event.clientX-songlist.offset().left)<65){
playlistController.selectSong(element)
return;
}
if(element.isPlaylist){
if(element.gid){
playlistController.showPlaylist(element);
}else{
searchController.showPlaylist(element);
}
}else{
playbackController.playSong(element,onlyStyle,false,true);
}
event.stopPropagation();
}

playbackController.playSong=function(song,resetingSong,playedAutomatic,addSongToQueue){
if(playbackController.playSongTimer&&Date.now()-playbackController.playSongTimer<100){
playbackController.playSongTimer=Date.now();
return;
}else
playbackController.playSongTimer=Date.now();
mediaController.versionListSong=null;
var listElement=playbackController.getListElementFromElement(song);
if(!resetingSong){
var isSameSongAsLoadedSong=listElement.hasClass("oldloadedsong")||(listElement.hasClass("loadedsong")&&playbackController.playingSong&&(((!song.gid)||(playbackController.playingSong.gid==song.gid))&&playbackController.playingSong.name==song.name)&&(mediaController.getSongArtist(playbackController.playingSong)==mediaController.getSongArtist(song)));
if(isSameSongAsLoadedSong){
if(playbackController.isLoading){
playbackController.resetPlayingSong();
return;
}
else if(playbackController.playingSong){
if(!listElement.hasClass("stillloading")){
setTimeout(function(){
videoController.playPauseSong();
},50);
}
return;
}
}
}
if(!playbackController.isLoading&&playbackController.playingSong){
playbackController.playingOldSong=playbackController.playingSong;
}
playbackController.updatePlayingSongIndex();
playbackController.playingSong=jQuery.extend(true,{},song);
if(playlistController.getLoadedPlaylist().isSimilarSongs)
playlistController.getSimilarSongs(playbackController.playingSong);
$(".songlist li.loadedsong.stillloading").removeClass("loadedsong stillloading");
$(".songlist li.loadedsong").addClass("oldloadedsong").removeClass("loadedsong");listElement.removeClass("playing pausing oldloadedsong");
listElement.addClass("loadedsong");
var addedToQueue=false;
if(!resetingSong){
if(!isSameSongAsLoadedSong){
playbackController.setNewTitle(playbackController.playingSong.name,mediaController.getSongCover(playbackController.playingSong));
if(addSongToQueue){
if(playbackController.playingSong.playlistgid!=playlistController.currentQueue.gid){
var actSong=jQuery.extend(true,{},song);
actSong.playlistgid=playlistController.currentQueue.gid;
var actSongList=[actSong];
playlistController.prepareGIDsToInsertSongsIntoPlaylist(playlistController.currentQueue,actSongList)
playbackController.playingSong.gid=actSong.gid;playbackController.playingSong=actSongList[0];
setTimeout(function(){
playlistController.insertSongsIntoQueue(actSongList);
playbackController.updatePlayingSongIndex();
},0);
if(playlistController.loadedPlaylists["0"])
addedToQueue=true;
}else
playbackController.updatePlayingSongIndex();
if(!playedAutomatic&&playlistController.playlistMode){
setTimeout(function(){
playlistController.animateAddedToList($(".currentqueue"));
},300)
}
}else
playbackController.updatePlayingSongIndex();
playbackController.isLoading=true;
playbackController.playingSongTimer=null;
playbackController.startedLoadingTime=Date.now();
if(playbackController.playingSong.streamURL)
mediaController.playStreamURL(playbackController.playingSong.streamURL);
else
mediaController.playStream(mediaController.getSongArtist(playbackController.playingSong),playbackController.playingSong.name,playedAutomatic,1);
playbackController.playedSongs.push(playbackController.playingSong);
}
}
$scope.safeApply();
if(!addedToQueue){
playbackController.remarkSong();
}
setTimeout(function(){
$("#playingSongInfoLink").css("opacity","1");
$("#buySongLink").css("opacity","1");
},500)
setTimeout(function(){
if(mediaController.showLyrics)
$("#lyricsifrm").attr("src","http://lyrics.wikia.com/"+mediaController.getSongArtist(playbackController.playingSong)+":"+playbackController.playingSong.name);
videoController.disableLyricsControl(false);
videoController.disableShareSocialControl(false);
if(!playbackController.playingOldSong)
videoController.disableStopControl(false);
videoController.disableControls(false);
},0)
}

playbackController.resetPlayingSong=function(){
console.log("RESETTTTT")
playbackController.isLoading=false;
mediaController.playCounter=mediaController.playCounter+1;
$(".videoControlElements-controls").find('.videoControlElements-time-loaded').show();
videoController.showBuffering(false);
playbackController.playingSong=playbackController.playingOldSong;
$(".songlist li").removeClass("loadedsong playing stillloading pausing");
if(playbackController.playingSong){
playbackController.playSongTimer=0;
playbackController.playSong(playbackController.playingSong,true);playbackController.setNewTitle(playbackController.playingSong.name,mediaController.getSongCover(playbackController.playingSong),true);
}
else{
$(".songlist li.loadedsong.stillloading .loadingSongImg").hide();
videoController.disableControls(true);
videoController.disableStopControl(true);
$(".iScrollPlayIndicator").hide();
playbackController.setNewTitle("","",true);
$(".videoControlElements-button-lyrics button").css("opacity","0.5");
}
}

playbackController.updatePlayingSongIndex=function(){
playbackController.playingSongIndex=0;
if(playbackController.playingSong){
for(var i=playlistController.currentQueue.tracks.length-1;i>=0;i--){
if(playlistController.currentQueue.tracks[i].gid==playbackController.playingSong.gid){
playbackController.playingSongIndex=i;
console.log("........ "+i)
break;
}
}
}else if(playlistController.currentQueue.tracks&&playlistController.currentQueue.tracks.length>0){
playbackController.playingSongIndex=playlistController.currentQueue.tracks.length-1;
}
};

playbackController.setNewTitle=function(title,coverUrl,isLoaded){
if(!isLoaded){
facebookHandler.updateSongFBButtons();
$("#playingSongCover").removeClass("fadeincomplete")
$("#playingSongTitle").removeClass("fadeincomplete");
$("#playingSongTitle").hide();
$("#playingSongTitleLoading").hide();
$("#playingSongCover").hide();
}
setTimeout(function(){
$("#playingSongTitleLoading").removeClass("fadeincomplete").removeClass("fadeoutcomplete");
if(title&&title!="")
document.title=$scope.appTitle+" : "+title;
else
document.title=$scope.appTitle;
var searchinput="";
if($("#searchinput").val()){
searchinput=$("#searchinput").val()
}

if(!isLoaded){
coverUrl="public/img/loadertitle.gif";
$("#playingSongInfoStyle").remove();
var style=$('<style id="playingSongInfoStyle">'+
'.playingSongInfo.ui-icon-custom:after  {'+
' background-image: url('+coverUrl+')'+
'}'+
'#popupArtist-popup::before{'+
'  background-color:rgba(255,255,255,.5)!important'+
'}'+
'</style>');
$('html > head').append(style);
}
else{
$("#playingSongInfoStyle").remove();
style=$('<style id="playingSongInfoStyle">'+
'.playingSongInfo.ui-icon-custom:after  {'+
' background-image: url('+coverUrl+')'+
'}'+
'#popupArtist-popup::before{'+
'  background: url('+coverUrl+');'+
'  background-size:cover;!important'+
'}'+
'</style>');
$('html > head').append(style);
}
$scope.safeApply();
setTimeout(function(){
if(isLoaded){
$("#playingSongTitleLoading").addClass("fadeoutcomplete")
$("#playingSongTitleLoading").show();
}
else{
$("#playingSongCover").addClass("fadeincomplete")
$("#playingSongCover").show();
$("#playingSongTitleLoading").addClass("fadeincomplete")
$("#playingSongTitleLoading").show();
$("#playingSongTitle").addClass("fadeincomplete")
$("#playingSongTitle").show();
}
},50)
},150)
}

playbackController.playPrevSong=function(){
if(playlistController.currentQueue.tracks.length==1){
videoController.setProgressPercentage(0);
videoController.setProgressTime(0);
videoController.videoPlayer.setProgressPercentage(0);
setTimeout(function(){
videoController.playSong();
},0)
}else{
var emptyList=false;
var index=playbackController.getIndexOfSong(playbackController.playingSong,playlistController.currentQueue.tracks);
if(index==-1){
if(playbackController.playedSongs.length==0){
index=1;
}
emptyList=true;
}
if(playbackController.playedSongs.length>0){
var song=playbackController.playedSongs[playbackController.playedSongs.length-1];
playbackController.playedSongs.splice(playbackController.playedSongs.length-1,1);
var alreadyInList=((!song.gid||(song.gid==playbackController.playingSong.gid))&&song.name==playbackController.playingSong.name&&mediaController.getSongArtist(song)==mediaController.getSongArtist(playbackController.playingSong));
if(alreadyInList){
if(playbackController.playedSongs.length>=1){
song=playbackController.playedSongs[playbackController.playedSongs.length-1];
playbackController.playedSongs.splice(playbackController.playedSongs.length-1,1);
}
else
song=null;
}
}
if(!song){
if(emptyList){
if(playlistController.currentQueue.tracks.length==0){
videoController.disablePositionControls(true);
return;
}
else
index=0;
}
else
index=index-1;
if(index<=-1)
index=playlistController.currentQueue.tracks.length-1;
playbackController.playSong(playlistController.currentQueue.tracks[index])

}else{
playbackController.playSong(song)
}
}
}

playbackController.playNextSong=function(){
if(playlistController.currentQueue.tracks.length==1){
videoController.setProgressPercentage(0);
videoController.setProgressTime(0);
videoController.videoPlayer.setProgressPercentage(0);
setTimeout(function(){
videoController.playSong();
},0)
}else{
var index=playbackController.getIndexOfSong(playbackController.playingSong,playlistController.currentQueue.tracks);
if(index>=0){
if(!videoController.shuffleMode){
index=index+1;
if(index==playlistController.currentQueue.tracks.length)
index=0;
}else if(playlistController.currentQueue.tracks.length>1){
var oIndex=index;
do{
index=Math.round(Math.random()*(playlistController.currentQueue.tracks.length-1))
}
while(index==oIndex)
}
playbackController.playSong(playlistController.currentQueue.tracks[index],false,true)
}else if(playlistController.currentQueue.tracks.length>0){
playbackController.playSong(playlistController.currentQueue.tracks[0],false,true)
}else
videoController.disablePositionControls(true);
}
}

playbackController.positionPlayIndicator=function(){
var listElement=playbackController.getListElementFromElement(playbackController.playingSong);
if(!listElement||listElement.length==0){
$("#searchlist .iScrollPlayIndicator").hide();
$("#playlistInner .iScrollPlayIndicator").hide();
}else{
if(listElement.parents("#playlistInner").length>0){
var scrollHeight=$("#playlistInner .iScrollVerticalScrollbar").height();
var listElementPlaylist=listElement.filter(':noparents(#playlistInner)');
var otherTopHeight=$("#playlistInner .othertopheight.songlisttitlebutton:visible").length*10;
var otherTopElements=$("#playlistInner .othertopheight:visible");
for(var i=0;i<otherTopElements.length;i++){
otherTopHeight=otherTopHeight+$(otherTopElements.get(i)).height();
}
otherTopHeight=otherTopHeight/($("#playlistInner ul").outerHeight()-65)*scrollHeight;
var otherBottomHeight=$("#playlistInner .otherbottomheight.songlisttitlebutton:visible").length*10;
var otherBottomElements=$("#playlistInner .otherbottomheight:visible");
for(i=0;i<otherBottomElements.length;i++){
otherBottomHeight=otherBottomHeight+$(otherBottomElements.get(i)).height();
}
otherBottomHeight=otherBottomHeight/($("#playlistInner ul").outerHeight()-65)*scrollHeight;
var position=listElementPlaylist.get(0).dataset.index;
var y=5+parseInt(position)/(Math.min(playlistController.getDisplayLimit(),playlistController.loadedPlaylistSongs.length)-1)*(scrollHeight-otherTopHeight-otherBottomHeight)+otherTopHeight;
if(y>scrollHeight)
y=scrollHeight;
$("#playlistInner .iScrollPlayIndicator").css('-webkit-transform','translate(0px,'+y+'px)').css('-moz-transform','translate(0px, '+y+'px)').css('-ms-transform','translate(0px, '+y+'px)').css('transform','translate(0px, '+y+'px)')
$("#playlistInner .iScrollPlayIndicator").show();
}else
$("#playlistInner .iScrollPlayIndicator").hide();
if(listElement.parents("#searchlist").length>0){
scrollHeight=$("#searchlist .iScrollVerticalScrollbar").height();
var listElementSearchlist=listElement.filter(':noparents(#searchlist)');
otherTopHeight=$("#searchlist .othertopheight.songlisttitlebutton:visible").length*10;
otherTopElements=$("#searchlist .othertopheight:visible");
for(var i=0;i<otherTopElements.length;i++){
otherTopHeight=otherTopHeight+$(otherTopElements.get(i)).height();
}
otherTopHeight=otherTopHeight/($("#searchlist ul").outerHeight()-65)*scrollHeight;
otherBottomHeight=$("#searchlist .otherbottomheight.songlisttitlebutton:visible").length*10;
otherBottomElements=$("#searchlist .otherbottomheight:visible");
for(i=0;i<otherBottomElements.length;i++){
otherBottomHeight=otherBottomHeight+$(otherBottomElements.get(i)).height();
}
otherBottomHeight=otherBottomHeight/($("#searchlist ul").outerHeight()-65)*scrollHeight;
position=listElementSearchlist.get(0).dataset.index;
y=5+parseInt(position)/(Math.min(searchController.getShowModeLimit(1),searchController.songs.searchResults.length)-1)*(scrollHeight-otherTopHeight-otherBottomHeight)+otherTopHeight;
if(y>scrollHeight)
y=scrollHeight;
$("#searchlist .iScrollPlayIndicator").css('-webkit-transform','translate(0px,'+y+'px)').css('-moz-transform','translate(0px, '+y+'px)').css('-ms-transform','translate(0px, '+y+'px)').css('transform','translate(0px, '+y+'px)')
if($("#searchlist .iScrollPlayIndicator:visible").length==0){
$("#searchlist .iScrollPlayIndicator").show();
}
}else
$("#searchlist .iScrollPlayIndicator").hide();
}
}

playbackController.positionPlayIndicatorAtTop=function(searchlist){
var y=0;
if(playbackController.playingSong){
if(playbackController.playingSong.gid&&!searchlist){
$("#playlistInner .iScrollPlayIndicator").css('-webkit-transform','translate(0px,'+y+'px)').css('-moz-transform','translate(0px, '+y+'px)').css('-ms-transform','translate(0px, '+y+'px)').css('transform','translate(0px, '+y+'px)')
}
else{
$("#searchlist .iScrollPlayIndicator").css('-webkit-transform','translate(0px,'+y+'px)').css('-moz-transform','translate(0px, '+y+'px)').css('-ms-transform','translate(0px, '+y+'px)').css('transform','translate(0px, '+y+'px)')
}
}
}

playbackController.getListElementFromElement=function(element,onlyList){
if(!element)
return $([]);
var playlistElements=[],searchListElements=[];
if(!onlyList||onlyList==1)
searchListElements=$("#searchlist li[data-elementtitle='"+mediaController.getElementTitle(element)+"'] ");
if(!onlyList||onlyList==2)
playlistElements=$("#playlistInner li[data-songgid='playlistsong"+element.gid+"']");
return $(searchListElements).add(playlistElements);
}

playbackController.isPlayingSong=function(song){
if(playbackController.playingSong&&song)
return song.gid==playbackController.playingSong.gid||(mediaController.getSongDisplayName(song)==mediaController.getSongDisplayName(playbackController.playingSong))
else
return false;
}

playbackController.isLoadingSong=function(song){
return playbackController.isPlayingSong(song)&&playbackController.isLoading;
}

playbackController.remarkSong=function(){
if(uiController.dontRemark){
setTimeout(function(){
playbackController.remarkSong();
},150)
}
else{
var listElement;
listElement=playbackController.getListElementFromElement(playbackController.playingSong);
$(".songlist .loadedsong").not(listElement).removeClass("loadedsong");
var safe=$(".songlist .oldloadedsong.playing")
$(".songlist .playing").not(listElement).removeClass("playing");
safe.addClass("playing")
safe=$(".songlist .oldloadedsong.pausing")
$(".songlist .pausing").removeClass("pausing");
safe.addClass("pausing")
$(".songlist .stillloading").not(listElement).removeClass("stillloading");
if(playbackController.playingSong){
if(listElement.length>0){
playbackController.positionPlayIndicator();
listElement.addClass("loadedsong");
if(playbackController.isLoading){
listElement.addClass("stillloading");
}else if(videoController.isPlaying){
listElement.addClass("playing");
listElement.removeClass("pausing");
}
else{
listElement.addClass("pausing");
listElement.removeClass("playing");
}
}
}
}
}

playbackController.getPlayingTitle=function(){
if(playbackController.playingSong){
return mediaController.getSongDisplayName(playbackController.playingSong);
}
else
return"";
}

playbackController.getPlayingSong=function(){
if(playbackController.playingSong)
return playbackController.playingSong;
else
return{name:""};
}

playbackController.getIndexOfSong=function(song,list){
for(var index=0;index<list.length;index++){
if((!song.gid||(song.gid==list[index].gid))&&song.name==list[index].name&&mediaController.getSongArtist(song)==mediaController.getSongArtist(list[index])){
return index;
}
}
return-1;
}

;
