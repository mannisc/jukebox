/** * facebookHandler. * * >>Description<< * * @author Manfred * @date 25.04.14 - 16:15 * @copyright munichDev UG */var facebookHandler = function () {};facebookHandler.loggedIn = false;facebookHandler.login = function () {    $.mobile.loading("hide")    $.mobile.loading("show", {        text: "Login",        textVisible: true,        textonly: false,        html: ""    });    $("#popupLogin").popup("close");    $("#popupRegister").popup("close");    setTimeout(function () {        $.mobile.loading("hide");    }, 20000)    facebookHandler.manuallyLoggingIn = true;    FB.login(function (response) {        if (!response.authResponse) {            $.mobile.loading("hide");        }    }, {scope: 'public_profile, email'});};facebookHandler.logout = function () {    facebookHandler.logoutTimer = Date.now();    facebookHandler.logoutTimer = Date.now();    facebookHandler.loggedIn = false;    // FB.logout()};/*** * Logged in successfully * @param response */facebookHandler.authAndLoggedIn = function (response) {    if (accountController.loggedIn && !facebookHandler.loggedIn) {        facebookHandler.loggedIn = true;    } else if (!facebookHandler.loggedIn) {        var loginResponse = response;        $.mobile.loading("hide")        $.mobile.loading("show", {            text: "Login",            textVisible: true,            textonly: false,            html: ""        });        $("#popupLogin").popup("close");        $("#popupRegister").popup("close");        FB.api('/me', function (response) {            if (!(!response.email || !response.id || !response.name || !loginResponse.authResponse.accessToken))                accountController.socialSignIn(response.name, response.email, response.id, 1, loginResponse.authResponse.accessToken)        });    }}facebookHandler.init = function () {    //Fb Async init    window.fbAsyncInit = function () {        FB.init({            appId: '467888830036802',            status: true, // check login status            cookie: true, // enable cookies to allow the server to access the session            xfbml: true  // parse XFBML        });        //Subscribe to FB API Events        FB.Event.subscribe('auth.authResponseChange', function (response) {            if (response.status === 'connected') {                var fbLogin = accountController.getCookie("fbLogin");                var socialAutoLogin = (fbLogin && Base64.decode(fbLogin) == "true");                if (socialAutoLogin || facebookHandler.manuallyLoggingIn)                    facebookHandler.authAndLoggedIn(response);            } else if (response.status === 'not_authorized') {                //empty            } else {                if (!facebookHandler.logoutTimer || Date.now() - facebookHandler.logoutTimer > 2000) {                    // console.log("AUTOLOGIN!!!!!"+(Date.now()-    facebookHandler.logoutTimer)+"  "+   facebookHandler.logoutTimer)                    FB.login(function (response) {                    }, {scope: 'public_profile, email'});                }            }        });    };    // Load the SDK asynchronously    (function (d) {        var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];        if (d.getElementById(id)) {            return;        }        js = d.createElement('script');        js.id = id;        js.async = true;        js.src = "//connect.facebook.net/en_US/all.js";        ref.parentNode.insertBefore(js, ref);    }(document));};/** * Update FB Buttons */facebookHandler.updateSongFBButtons = function () {    if (playbackController.playingSong)        $("#fbartistbox").html(preloadhtml.sharefbartist.replace("songbase.fm", "songbase.fm?artist=" + mediaController.getSongArtist(playbackController.playingSong)));    else        $("#fbartistbox").html(preloadhtml.sharefbartist);    if (playbackController.playingSong)        $("#fbtitlebox").html(preloadhtml.sharefbsong.replace("songbase.fm", "songbase.fm?play=" + playbackController.getPlayingTitle()));    else        $("#fbtitlebox").html(preloadhtml.sharefbsong);    try {        FB.XFBML.parse($("#fbtitlebox").get(0));        FB.XFBML.parse($("#fbartistbox").get(0));    } catch (ex) {    }};facebookHandler.postOnFacebook = function () {    if (playbackController.playingSong) {        mediaController.sendRating("1");        var song = playbackController.getPlayingSong();        var fburl = "http://www.songbase.fm?play=" + playbackController.getPlayingTitle() + "&t=" + playbackController.getPlayingTitle();    }    else {        fburl = "http://www.songbase.fm&t=songbase.fm - All Your Music";    }    var fbWindow = window.open("http://www.facebook.com/sharer.php?u=" + fburl, "", "");    fbWindow.focus();};